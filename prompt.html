<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .optionsDiv {
            display: flex;
            margin: 10px;
            justify-content: space-between;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <div>
        <div id="myForm">
            <form id="form">
            </form>
            <div id="errOut"></div>
        </div>
    </div>
</body>

<script>
    console.log("Retrieving data from apps script...")
    const data = JSON.parse(<?= JSON.stringify(data) ?>)

    function setup() {

        function createOptions(data) {
            return data.map(item => {
                const option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                return option
            })
        }
        function createDiv(id, text, data, onchange) {
            const div = document.createElement("div");
            const label = document.createElement("label");
            label.for = id;
            label.textContent = text

            const select = document.createElement("select");
            select.name = id;
            select.id = id;
            if (onchange) {
                select.onchange = onchange;
            }

            select.append(...createOptions(data));
            select.prepend((() => {
                const o = document.createElement("option")
                o.value = null
                o.disabled = true
                o.selected = true
                o.textContent = "-Auswählen-"
                return o
            })())

            div.append(label, select)
            div.classList.add("optionsDiv")
            return div
        }

        console.log("Parsing data...")
        const {active, colDict} = data
        console.log(colDict)

        const parent = document.getElementById("form")
        const sheets = Object.keys(colDict)
        parent.append(
            createDiv("order", "Bestellliste", sheets,
                () => {
                    const affected = ["target", "size"]
                    const myValue = document.getElementById("order").value
                    affected.map(s => document.getElementById(s)).forEach(s => {
                        s.innerHTML = '';
                        s.append(...createOptions(colDict[myValue]))
                    })
                }),
            createDiv("inventory", "Bestandliste", sheets,
                () => {
                    const affected = ["current", "join"]
                    const myValue = document.getElementById("inventory").value
                    affected.map(s => document.getElementById(s)).forEach(s => {
                        s.innerHTML = '';
                        s.append(...createOptions(colDict[myValue]))
                    })
                }),

            createDiv("target", "Soll (Kapazität)", []),
            createDiv("size", "Menge (Verpackungseinheit)", []),
            createDiv("join", "Identifier (ID/Name)", []),
            createDiv("current", "Ist (Bestand)", []),
        )

        const button = document.createElement("input")
        button.type = "button"
        button.value = "Bestellung generieren"
        button.onclick = () => {
            const get = (id) => document.getElementById(id).value
            button.value = "Einen Moment..."

            google.script.run.withFailureHandler((e) => {
                alert(e)
                document.getElementById("errOut").textContent = e
            }).withSuccessHandler((res) => alert(res)).processForm(
                get("order"), get("inventory"), get("join"), get("current"), get("target"), get("size"))
        }

        parent.append(button)
    }

    setup()
</script>
</html>